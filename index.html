<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>幻境 PPT 助手</title>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- PptxGenJS -->
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Noto+Sans+SC:wght@300;400;500&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0a1111;
            --accent-gold: #d4b778;
            --accent-cyan: #6fffe9;
            --text-primary: #e0e0e0;
        }
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            overflow: hidden;
            margin: 0;
        }

        .font-serif { font-family: 'Noto Serif SC', 'Cinzel', serif; }

        /* 背景画布 */
        #particle-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none;
        }

        /* 游戏容器 (Dialog) */
        .game-container {
            background: rgba(15, 20, 22, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 60px rgba(0,0,0,0.8), inset 0 0 0 1px rgba(212, 183, 120, 0.1);
            position: relative;
            overflow: hidden;
        }
        .game-container::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-gold), transparent);
        }
        .game-container::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-cyan), transparent);
        }

        /* 步骤切换动画 */
        .step-enter-active, .step-leave-active { transition: all 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        .step-enter-from { opacity: 0; transform: translateX(50px) scale(0.95); filter: blur(10px); }
        .step-leave-to { opacity: 0; transform: translateX(-50px) scale(0.95); filter: blur(10px); }

        /* 输入框 */
        .magic-input {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #fff;
            transition: all 0.3s;
        }
        .magic-input:focus {
            background: rgba(0, 0, 0, 0.8);
            border-color: var(--accent-cyan);
            box-shadow: 0 0 15px rgba(111, 255, 233, 0.2);
            outline: none;
        }

        /* 按钮 */
        .game-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        .game-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            filter: brightness(1.2);
            box-shadow: 0 5px 20px rgba(111, 255, 233, 0.2);
        }
        .game-btn:disabled { filter: grayscale(1); opacity: 0.5; cursor: not-allowed; }

        /* 打字机光标 */
        .typing-cursor::after {
            content: '|';
            animation: blink 1s step-end infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* 扫描线 */
        .scanlines {
            position: fixed; inset: 0; pointer-events: none; z-index: 5;
            background: repeating-linear-gradient(to bottom, transparent 0, transparent 2px, rgba(0,0,0,0.2) 3px);
            opacity: 0.1;
        }

        /* 结果页特殊样式 */
        .result-view {
            animation: fade-in 1s ease-out;
        }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }

        /* 进度条动画 */
        .progress-fill {
            background: linear-gradient(90deg, var(--accent-gold), var(--accent-cyan));
            background-size: 200% 100%;
            animation: gradient-move 2s linear infinite;
        }
        @keyframes gradient-move { 0% { background-position: 100% 0; } 100% { background-position: -100% 0; } }

        [v-cloak] { display: none; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden bg-[#05080a] relative flex items-center justify-center">
    
    <canvas id="particle-canvas"></canvas>
    <div class="scanlines"></div>
    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] opacity-20 pointer-events-none"></div>

    <div id="app" v-cloak class="relative z-10 w-full h-full flex flex-col items-center justify-center p-4">
        
        <!-- 步骤 0-4: 引导流程 -->
        <transition name="step" mode="out-in">
            
            <!-- STEP 0: 启动 -->
            <div v-if="step === 0" key="step0" class="text-center">
                <div class="w-24 h-24 mx-auto mb-6 relative">
                    <div class="absolute inset-0 border-2 border-[#d4b778] rotate-45 animate-[spin_10s_linear_infinite]"></div>
                    <div class="absolute inset-3 border-2 border-[#6fffe9] -rotate-45 animate-[spin_8s_linear_infinite_reverse]"></div>
                    <v-icon name="presentation" class="text-[#d4b778] absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2" :size="40"></v-icon>
                </div>
                <h1 class="text-5xl md:text-6xl font-serif font-bold text-transparent bg-clip-text bg-gradient-to-b from-[#d4b778] to-[#fff] mb-4 tracking-widest drop-shadow-[0_0_20px_rgba(212,183,120,0.3)]">幻境 PPT 助手</h1>
                <p class="text-[#8a9a9a] text-sm tracking-[0.3em] mb-12 uppercase typing-cursor">Presentation Matrix Loading...</p>
                <button @click="nextStep" class="game-btn px-10 py-4 bg-[#d4b778] text-[#0a1111] font-bold text-lg tracking-widest hover:bg-[#ffe0a3]">
                    进入工作台
                </button>
            </div>

            <!-- STEP 1: 配置连接 -->
            <div v-else-if="step === 1" key="step1" class="game-container w-full max-w-lg p-8 rounded-xl text-center">
                <div class="text-[#6fffe9] text-xs font-bold tracking-widest mb-2 uppercase">Step 01 // Link</div>
                <h2 class="text-2xl font-serif text-white mb-6">接入智识网络 <span class="text-sm opacity-50 font-sans">(API配置)</span></h2>
                
                <div class="space-y-4 text-left">
                    <div>
                        <label class="text-[10px] text-[#8a9a9a] uppercase mb-1 block">API 网关地址</label>
                        <input v-model="config.baseUrl" class="magic-input w-full p-3 rounded" placeholder="https://api.openai.com/v1">
                    </div>
                    <div>
                        <label class="text-[10px] text-[#8a9a9a] uppercase mb-1 block">API 密钥令符</label>
                        <input v-model="config.apiKey" type="password" class="magic-input w-full p-3 rounded" placeholder="sk-...">
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button @click="step--" class="text-[#8a9a9a] hover:text-white text-sm px-4">返回</button>
                    <button @click="nextStep" :disabled="!config.apiKey" class="game-btn px-8 py-2 bg-[#6fffe9] text-[#0a1111] font-bold tracking-wider">
                        验证链接
                    </button>
                </div>
            </div>

            <!-- STEP 2: 任务简报 -->
            <div v-else-if="step === 2" key="step2" class="game-container w-full max-w-lg p-8 rounded-xl text-center">
                <div class="text-[#d4b778] text-xs font-bold tracking-widest mb-2 uppercase">Step 02 // Content</div>
                <h2 class="text-2xl font-serif text-white mb-6">绘制演示蓝图</h2>
                
                <div class="space-y-4 text-left">
                    <div>
                        <label class="text-[10px] text-[#8a9a9a] uppercase mb-1 block">核心议题 (Theme)</label>
                        <textarea v-model="topic" class="magic-input w-full h-20 p-3 rounded text-base resize-none" placeholder="请输入演示文稿的主题..."></textarea>
                    </div>
                    <div>
                        <label class="text-[10px] text-[#8a9a9a] uppercase mb-1 block flex items-center gap-2">
                            <span class="w-1.5 h-1.5 bg-[#6fffe9] rotate-45"></span>
                            补充咒文 / 详细要求 (Requirements)
                        </label>
                        <textarea v-model="additionalInfo" class="magic-input w-full h-24 p-3 rounded text-sm resize-none" placeholder="例如：需包含团队介绍、特别强调Q3增长数据、风格要幽默、包含竞争对手分析..."></textarea>
                    </div>
                </div>

                <div class="flex justify-between mt-8">
                    <button @click="step--" class="text-[#8a9a9a] hover:text-white text-sm px-4">返回</button>
                    <button @click="nextStep" :disabled="!topic.trim()" class="game-btn px-8 py-2 bg-[#d4b778] text-[#0a1111] font-bold tracking-wider">
                        确认蓝图
                    </button>
                </div>
            </div>

            <!-- STEP 3: 视觉校准 -->
            <div v-else-if="step === 3" key="step3" class="game-container w-full max-w-lg p-8 rounded-xl text-center">
                <div class="text-[#cc99cc] text-xs font-bold tracking-widest mb-2 uppercase">Step 03 // Style</div>
                <h2 class="text-2xl font-serif text-white mb-6">演示风格调优</h2>
                
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div class="text-left">
                        <label class="text-[10px] text-[#8a9a9a] uppercase mb-2 block">主题灵光 (配色)</label>
                        <div class="flex items-center gap-3 bg-black/40 p-2 rounded border border-white/10">
                            <input type="color" v-model="pptConfig.themeColor" class="h-8 w-12 cursor-pointer bg-transparent border-0 p-0">
                            <span class="font-mono text-xs text-[#d4b778]">{{ pptConfig.themeColor }}</span>
                        </div>
                    </div>
                    <div class="text-left">
                        <label class="text-[10px] text-[#8a9a9a] uppercase mb-2 block">幻灯片页数 ({{ pptConfig.pageCount }})</label>
                        <input type="range" v-model.number="pptConfig.pageCount" min="4" max="12" class="w-full h-2 bg-white/10 rounded-full appearance-none accent-[#cc99cc] mt-3">
                    </div>
                </div>

                <div class="text-left mb-8">
                    <label class="text-[10px] text-[#8a9a9a] uppercase mb-2 block">背景底纹 (可选)</label>
                    <label class="flex items-center justify-center gap-2 border border-dashed border-white/20 hover:border-[#cc99cc] p-3 rounded cursor-pointer transition-colors bg-black/20">
                        <input type="file" @change="handleBgUpload" class="hidden" accept="image/*">
                        <v-icon :name="pptConfig.templateBg ? 'check' : 'upload'" :size="16" :class="pptConfig.templateBg ? 'text-green-400' : 'text-[#8a9a9a]'"></v-icon>
                        <span class="text-xs text-[#ccc]">{{ pptConfig.templateBg ? '纹理已加载' : '上传图片文件' }}</span>
                    </label>
                </div>

                <div class="flex justify-between">
                    <button @click="step--" class="text-[#8a9a9a] hover:text-white text-sm px-4">返回</button>
                    <button @click="startGeneration" class="game-btn px-8 py-2 bg-gradient-to-r from-[#cc99cc] to-[#d4b778] text-[#0a1111] font-bold tracking-wider w-full ml-4 shadow-[0_0_20px_rgba(204,153,204,0.3)]">
                        启动生成仪式
                    </button>
                </div>
            </div>

            <!-- STEP 4: 生成中 -->
            <div v-else-if="step === 4" key="step4" class="text-center w-full max-w-md">
                <div class="mb-4 font-mono text-[#6fffe9] text-sm h-6">
                    > {{ generationLog }}<span class="typing-cursor"></span>
                </div>
                <!-- Progress Bar -->
                <div class="w-full h-2 bg-[#0a1111] border border-[#333] rounded-full overflow-hidden relative">
                    <div class="h-full progress-fill transition-all duration-300" :style="{width: progressWidth + '%'}"></div>
                </div>
                <div class="mt-2 flex justify-between text-[10px] text-[#444] font-mono">
                    <span>PROCESSING</span>
                    <span>{{ progressWidth }}%</span>
                </div>
            </div>

            <!-- STEP 5: 结果页 (全息仪表盘) -->
            <div v-else-if="step === 5" key="step5" class="result-view w-full h-full flex flex-col glass-panel rounded-xl overflow-hidden shadow-2xl border border-[#d4b778]/30">
                <!-- Top Bar -->
                <header class="h-14 border-b border-white/5 bg-black/40 flex items-center justify-between px-6 backdrop-blur-md">
                    <div class="flex items-center gap-4">
                        <button @click="step = 0" class="text-[#d4b778] hover:text-white transition-colors" title="重启系统"><v-icon name="plus-circle" :size="18"></v-icon></button>
                        <div class="h-4 w-[1px] bg-white/10"></div>
                        <span class="font-serif text-lg text-white tracking-widest font-bold truncate max-w-md">{{ topic }}</span>
                    </div>
                    <div class="flex gap-3">
                        <button @click="step = 3" class="px-4 py-1.5 border border-white/10 rounded text-xs text-[#8a9a9a] hover:text-white hover:border-white/30 transition-all">调整风格</button>
                        <button @click="exportPPT" class="game-btn px-6 py-1.5 bg-[#d4b778] text-[#0a1111] text-xs font-bold tracking-widest flex items-center gap-2">
                            <v-icon name="download" :size="14"></v-icon> 导出 PPTX 文件
                        </button>
                    </div>
                </header>

                <!-- Grid Content -->
                <div class="flex-1 overflow-y-auto p-8 custom-scrollbar">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">
                        <!-- Cover -->
                        <div class="aspect-video glass-panel p-1 group slide-card rounded-lg relative overflow-hidden bg-black/40">
                            <div class="absolute inset-0 z-0 opacity-30">
                                <img v-if="pptConfig.templateBg" :src="pptConfig.templateBg" class="w-full h-full object-cover">
                                <div v-else class="w-full h-full bg-gradient-to-br from-[#d4b778]/20 to-transparent"></div>
                            </div>
                            <div class="relative z-10 w-full h-full flex flex-col items-center justify-center text-center p-4">
                                <h1 class="text-2xl font-serif font-bold text-white mb-2">{{ topic }}</h1>
                                <p class="text-[10px] text-[#d4b778] tracking-[0.3em]">{{ new Date().getFullYear() }} PRESENTATION</p>
                            </div>
                        </div>

                        <!-- Content Slides -->
                        <div v-for="(slide, index) in slides" :key="index" class="aspect-video glass-panel relative group slide-card rounded-lg flex flex-col overflow-hidden bg-black/20">
                            <div class="h-8 border-b border-white/5 flex justify-between items-center px-3 bg-white/[0.02]">
                                <span class="text-[9px] text-[#6fffe9] font-mono">第 0{{ index + 1 }} 页</span>
                                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button @click="openEditModal(index)" class="p-1 hover:text-[#d4b778]"><v-icon name="pencil" :size="12"></v-icon></button>
                                    <button @click="regenerateSlide(index)" :disabled="slide.isRegenerating" class="p-1 hover:text-[#6fffe9]">
                                        <v-icon :name="slide.isRegenerating ? 'loader' : 'refresh-cw'" :size="12" :class="slide.isRegenerating ? 'animate-spin' : ''"></v-icon>
                                    </button>
                                </div>
                            </div>
                            <div class="p-4 flex-1 relative flex flex-col">
                                <h3 class="text-sm font-bold text-[#d4b778] mb-2 line-clamp-1">{{ slide.title }}</h3>
                                
                                <!-- Content Preview -->
                                <div v-if="slide.layout === 'big-data'" class="flex-1 flex flex-col items-center justify-center">
                                    <div class="text-3xl font-serif text-white font-bold">{{ slide.dataValue }}</div>
                                    <div class="text-[8px] text-[#6fffe9] uppercase tracking-wider">{{ slide.dataLabel }}</div>
                                </div>
                                <div v-else class="flex gap-2 h-full">
                                    <div class="flex-1 text-[10px] text-[#aaa] line-clamp-4 leading-relaxed">{{ slide.content }}</div>
                                    <div v-if="slide.imgData" class="w-1/3 h-full bg-black/50 rounded overflow-hidden border border-white/10 relative group/img cursor-pointer" @click="openModal(slide.imgData)">
                                        <img :src="`data:image/png;base64,${slide.imgData}`" class="w-full h-full object-cover">
                                    </div>
                                    <div v-else class="w-1/3 h-full border border-dashed border-white/10 rounded flex items-center justify-center cursor-pointer hover:border-[#6fffe9]" @click="generateImage(index)">
                                        <v-icon :name="slide.imgLoading ? 'loader' : 'image-plus'" :size="16" class="text-[#444]" :class="slide.imgLoading ? 'animate-spin' : ''"></v-icon>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </transition>

        <!-- Modals -->
        <!-- Image Preview Modal -->
        <div v-if="uiState.modalImg" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-md p-8" @click="uiState.modalImg = null">
            <div class="relative max-w-5xl max-h-full border border-[#d4b778]/50 p-1 bg-[#0a1111]">
                <img :src="`data:image/png;base64,${uiState.modalImg}`" class="max-h-[85vh] block shadow-2xl">
            </div>
        </div>

        <!-- Edit Modal -->
        <div v-if="uiState.isEditing" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
            <div class="game-container w-full max-w-lg p-6 rounded-lg">
                <div class="flex justify-between items-center mb-6">
                    <span class="text-[#6fffe9] font-bold tracking-widest text-sm">重塑此页内容</span>
                    <button @click="closeEditModal"><v-icon name="x" :size="18" class="text-[#8a9a9a] hover:text-white"></v-icon></button>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <select v-model="editForm.layout" class="magic-input w-full h-9 px-2 rounded text-xs">
                            <option value="classic">经典</option>
                            <option value="big-data">数据</option>
                            <option value="timeline">时序</option>
                            <option value="comparison">对比</option>
                        </select>
                        <input v-model="editForm.title" class="magic-input w-full h-9 px-2 rounded text-xs">
                    </div>
                    <div v-if="editForm.layout === 'big-data'" class="grid grid-cols-2 gap-4">
                        <input v-model="editForm.dataValue" class="magic-input w-full h-8 px-2 rounded text-xs" placeholder="数值">
                        <input v-model="editForm.dataLabel" class="magic-input w-full h-8 px-2 rounded text-xs" placeholder="标签">
                    </div>
                    <textarea v-model="editForm.content" rows="4" class="magic-input w-full p-3 rounded text-xs"></textarea>
                    <textarea v-model="editForm.pointsStr" rows="3" class="magic-input w-full p-3 rounded text-xs" placeholder="列表项..."></textarea>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button @click="closeEditModal" class="px-4 py-2 text-xs text-[#8a9a9a] hover:text-white">取消</button>
                    <button @click="saveEdit" class="game-btn px-6 py-2 bg-[#6fffe9] text-[#0a1111] text-xs font-bold">保存</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, reactive, watch, onMounted } = Vue;

        const IconComponent = {
            props: ['name', 'size'],
            setup(props) {
                const container = ref(null);
                const updateIcon = () => {
                    if (!container.value) return;
                    container.value.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', props.name);
                    i.setAttribute('width', props.size || 16);
                    i.setAttribute('height', props.size || 16);
                    container.value.appendChild(i);
                    if (typeof lucide !== 'undefined' && lucide.createIcons) {
                        lucide.createIcons({ root: container.value, nameAttr: 'data-lucide' });
                    }
                };
                onMounted(updateIcon);
                watch(() => [props.name, props.size], updateIcon);
                return { container };
            },
            template: `<span ref="container" class="inline-flex items-center"></span>`
        };

        createApp({
            components: { 'v-icon': IconComponent },
            setup() {
                // State
                const step = ref(0);
                const progressWidth = ref(0);
                const generationLog = ref("Waiting...");
                
                const uiState = reactive({ showApi: false, modalImg: null, isEditing: false, editingIndex: -1 });
                const loading = ref(false);
                const error = ref('');
                const topic = ref('');
                const additionalInfo = ref('');
                const slides = ref([]);
                
                const editForm = reactive({ layout: 'classic', title: '', content: '', pointsStr: '', dataValue: '', dataLabel: '' });
                const config = reactive({ baseUrl: 'https://api.openai.com/v1', apiKey: '', textModel: 'gpt-4o', imageModel: 'dall-e-3' });
                const pptConfig = reactive({ themeColor: '#d4b778', bodyColor: '#e0e0e0', pageCount: 6, copyright: 'Fantasy System', templateBg: null });

                // Init
                onMounted(() => {
                    initParticles();
                    const c = localStorage.getItem('app_config_fantasy');
                    const p = localStorage.getItem('app_ppt_config_fantasy');
                    if(c) Object.assign(config, JSON.parse(c));
                    if(p) Object.assign(pptConfig, JSON.parse(p));
                });

                watch(config, v => localStorage.setItem('app_config_fantasy', JSON.stringify(v)), {deep:true});
                watch(pptConfig, v => localStorage.setItem('app_ppt_config_fantasy', JSON.stringify(v)), {deep:true});

                // Interaction
                const nextStep = () => { step.value++; };
                
                // Trigger Generation Flow
                const startGeneration = async () => {
                    step.value = 4;
                    progressWidth.value = 0;
                    generationLog.value = "Connecting to Creative Core...";
                    
                    // Simulated progress before real call
                    const logs = ["Parsing Presentation Structure...", "Synthesizing Slide Content...", "Formatting Slide Layouts...", "Rendering Visual Elements..."];
                    let logIdx = 0;
                    const interval = setInterval(() => {
                        if (progressWidth.value < 90) progressWidth.value += Math.random() * 5;
                        if (Math.random() > 0.7 && logIdx < logs.length) {
                            generationLog.value = logs[logIdx++];
                        }
                    }, 200);

                    try {
                        await generateOutlineLogic();
                        clearInterval(interval);
                        progressWidth.value = 100;
                        generationLog.value = "Presentation Matrix Loaded.";
                        setTimeout(() => { step.value = 5; }, 800);
                    } catch (e) {
                        clearInterval(interval);
                        error.value = e.message;
                        step.value = 3; // Go back
                    }
                };

                // --- 鲁棒性 JSON 提取函数 ---
                const parseAIResponse = (text) => {
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        const jsonBlock = text.match(/```json\s*([\s\S]*?)\s*```/i);
                        if (jsonBlock) {
                            try { return JSON.parse(jsonBlock[1]); } catch(e2){}
                        }
                        const arrayMatch = text.match(/\[[\s\S]*\]/);
                        if (arrayMatch) {
                            try { return JSON.parse(arrayMatch[0]); } catch(e3){}
                        }
                        const objMatch = text.match(/\{[\s\S]*\}/);
                        if (objMatch) {
                            try { return JSON.parse(objMatch[0]); } catch(e4){}
                        }
                        throw new Error("无法从 AI 响应中解析 JSON");
                    }
                };

                // --- Core Logic ---
                const generateOutlineLogic = async () => {
                    if (!topic.value.trim()) throw new Error('Topic required');
                    
                    const cleanBaseUrl = config.baseUrl.replace(/\/$/, '');
                    
                    const SYSTEM_PROMPT = `
你是一位资深的行业分析师。生成一份内容详实、专业、有数据的PPT大纲。
风格：专业、深度、严谨。
要求：
1. **必须返回合法的纯 JSON 数组**，不要包含任何 markdown 标记（如 \`\`\`json），不要包含任何解释性文字。
2. 'content' 字段必须包含一段 80-150 字的深入分析。
3. 当使用 'big-data' 版式时，必须虚构具体的业务数据。
4. 列表项 'items' 应该是“观点+论据”。
5. 生成 ${pptConfig.pageCount} 页。
6. layout 可选: "classic", "big-data", "timeline", "comparison".
`;
                    const userPrompt = `主题：${topic.value}\n补充要求：${additionalInfo.value || '无'}`;

                    const res = await fetch(`${cleanBaseUrl}/chat/completions`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${config.apiKey}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: config.textModel,
                            messages: [
                                { role: "system", content: SYSTEM_PROMPT }, 
                                { role: "user", content: userPrompt }
                            ],
                            temperature: 0.7 
                        })
                    });
                    const data = await res.json();
                    if(data.error) throw new Error(data.error.message);
                    
                    const content = data.choices[0].message.content;
                    const parsedData = parseAIResponse(content); 
                    
                    slides.value = parsedData.map(s => ({...s, imgData:null, imgLoading:false, isRegenerating:false}));
                };

                const handleBgUpload = (e) => {
                    const file = e.target.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => pptConfig.templateBg = ev.target.result;
                    reader.readAsDataURL(file);
                };

                const regenerateSlide = async (index) => {
                    const slide = slides.value[index];
                    slide.isRegenerating = true;
                    try {
                        const cleanBaseUrl = config.baseUrl.replace(/\/$/, '');
                        const REGEN_SYSTEM_PROMPT = `
你是一位 PPT 优化专家。你的任务是重写并优化指定的幻灯片内容。
要求：
1. **必须返回合法的纯 JSON 对象**，不要 markdown，不要废话。
2. 内容必须更加详实、专业。
3. JSON 格式必须包含: title, content, items, layout, dataValue (可选), dataLabel (可选)。
`;
                        const res = await fetch(`${cleanBaseUrl}/chat/completions`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${config.apiKey}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                model: config.textModel,
                                messages: [
                                    { role: "system", content: REGEN_SYSTEM_PROMPT },
                                    { role: "user", content: `请重写此页内容：${JSON.stringify(slide)}。主题为：${topic.value}。补充要求：${additionalInfo.value || '无'}` }
                                ]
                            })
                        });
                        const data = await res.json();
                        const content = data.choices[0].message.content;
                        const parsed = parseAIResponse(content);
                        
                        Object.assign(slide, parsed);
                    } catch (e) { alert('重写失败: ' + e.message); } finally { slide.isRegenerating = false; }
                };

                const generateImage = async (index) => {
                    const slide = slides.value[index];
                    slide.imgLoading = true;
                    try {
                        const cleanBaseUrl = config.baseUrl.replace(/\/$/, '');
                        const res = await fetch(`${cleanBaseUrl}/images/generations`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${config.apiKey}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                model: config.imageModel,
                                prompt: `Fantasy game UI style background illustration, ethereal, magical, dark cyan and gold theme, elegant, abstract. Context: ${slide.title}`,
                                n: 1, size: "1024x1024", response_format: "b64_json"
                            })
                        });
                        const data = await res.json();
                        if(data.error) throw new Error(data.error.message);
                        const imgItem = data.data?.[0];
                        if (imgItem.b64_json) slide.imgData = imgItem.b64_json;
                        else if (imgItem.url) {
                             const urlRes = await fetch(imgItem.url);
                             const blob = await urlRes.blob();
                             const reader = new FileReader();
                             reader.onloadend = () => { slide.imgData = reader.result.split(',')[1]; };
                             reader.readAsDataURL(blob);
                        }
                    } catch (e) { alert('配图生成失败: ' + e.message); } finally { slide.imgLoading = false; }
                };

                const openEditModal = (idx) => {
                    uiState.editingIndex = idx;
                    const s = slides.value[idx];
                    Object.assign(editForm, {
                        layout: s.layout || 'classic', title: s.title, content: s.content,
                        pointsStr: (s.items || []).join('\n'), dataValue: s.dataValue||'', dataLabel: s.dataLabel||''
                    });
                    uiState.isEditing = true;
                };
                const closeEditModal = () => uiState.isEditing = false;
                const saveEdit = () => {
                    const s = slides.value[uiState.editingIndex];
                    Object.assign(s, {
                        layout: editForm.layout, title: editForm.title, content: editForm.content,
                        items: editForm.pointsStr.split('\n').filter(x=>x.trim()),
                        dataValue: editForm.dataValue, dataLabel: editForm.dataLabel
                    });
                    closeEditModal();
                };

                // 导出 PPT 功能重写
                const exportPPT = () => {
                    const pptx = new PptxGenJS();
                    pptx.layout = 'LAYOUT_16x9';
                    
                    // 颜色常量
                    const bgDark = "0a1111";
                    const textMain = "e0e0e0";
                    const textDim = "8a9a9a";
                    const gold = pptConfig.themeColor.replace('#', '');
                    const cyan = "6fffe9";

                    // 母版定义
                    const masterOpts = {
                        title: "FANTASY_MASTER",
                        background: pptConfig.templateBg ? { data: pptConfig.templateBg } : { color: bgDark },
                        objects: [
                            // 顶部金色线条
                            { rect: { x: 0, y: 0, w: "100%", h: 0.05, fill: { color: gold } } },
                            // 底部青色线条
                            { rect: { x: 0, y: 7.45, w: "100%", h: 0.05, fill: { color: cyan } } },
                            // 角落装饰 (左上)
                            { rect: { x: 0.2, y: 0.2, w: 0.05, h: 0.5, fill: { color: gold } } },
                            { rect: { x: 0.2, y: 0.2, w: 0.5, h: 0.05, fill: { color: gold } } },
                            // 角落装饰 (右下)
                            { rect: { x: 13.1, y: 7.2, w: 0.05, h: 0.5, fill: { color: cyan } } },
                            { rect: { x: 12.6, y: 7.25, w: 0.55, h: 0.05, fill: { color: cyan } } }
                        ]
                    };
                    pptx.defineSlideMaster(masterOpts);

                    // 1. 封面页
                    const cover = pptx.addSlide();
                    if(pptConfig.templateBg) cover.background = { data: pptConfig.templateBg };
                    else cover.background = { color: bgDark };

                    // 封面中心装饰框
                    cover.addShape('rect', { x: 3.0, y: 2.0, w: 7.33, h: 3.5, line: { color: gold, width: 1.5 }, fill: { color: "000000", transparency: 60 } });
                    // 四角点缀
                    cover.addShape('rect', { x: 2.9, y: 1.9, w: 0.2, h: 0.2, fill: { color: gold } });
                    cover.addShape('rect', { x: 10.23, y: 5.4, w: 0.2, h: 0.2, fill: { color: gold } });

                    cover.addText("PORTFOLIO / PRESENTATION", { x: 3.0, y: 2.3, w: 7.33, fontSize: 10, color: gold, align: "center", charSpacing: 3 });
                    cover.addText(topic.value, { x: 3.2, y: 2.8, w: 6.93, fontSize: 40, bold: true, color: "FFFFFF", align: "center", fontFace: "Georgia" });
                    
                    // 封面中间的菱形装饰
                    cover.addShape('rect', { x: 6.5, y: 4.0, w: 0.3, h: 0.3, fill: { color: gold }, rotate: 45 });

                    cover.addText(new Date().toLocaleDateString(), { x: 3.0, y: 4.8, w: 7.33, fontSize: 12, color: cyan, align: "center" });

                    // 2. 内容页循环
                    slides.value.forEach((s, i) => {
                        const slide = pptx.addSlide({ masterName: "FANTASY_MASTER" });
                        
                        // 页码
                        slide.addText(`0${i+1}`, { x:0.3, y:0.4, fontSize:14, color:gold, fontFace:"Courier New" });
                        
                        // 标题栏装饰线
                        slide.addShape('line', { x: 0.8, y: 0.9, w: 11.7, h: 0, line: { color: "333333", width: 1 } });
                        // 标题
                        slide.addText(s.title, { x: 0.8, y: 0.4, w: 11.0, fontSize: 24, bold: true, color: textMain, fontFace: "Georgia" });

                        // --- 版式逻辑 ---
                        
                        // A. Big Data (核心数据)
                        if (s.layout === 'big-data') {
                            // 大数值
                            slide.addText(s.dataValue || '0%', { 
                                x: 0.5, y: 2.5, w: 12.33, 
                                align: 'center', fontSize: 80, bold: true, color: gold, fontFace: "Georgia" 
                            });
                            // 标签
                            slide.addText(s.dataLabel || 'METRIC', { 
                                x: 0.5, y: 4.0, w: 12.33, 
                                align: 'center', fontSize: 18, color: cyan, charSpacing: 4 
                            });
                            // 正文
                            slide.addText(s.content, { 
                                x: 3.5, y: 5.0, w: 6.33, 
                                align: 'center', fontSize: 14, color: textDim 
                            });
                        }
                        
                        // B. Timeline (时间轴)
                        else if (s.layout === 'timeline') {
                            slide.addText(s.content, { x: 0.8, y: 1.2, w: 11.7, h: 1.0, fontSize: 14, color: textMain });
                            
                            // 主轴线
                            slide.addShape('line', { x: 1.0, y: 4.5, w: 11.33, h: 0, line: { color: gold, width: 2 } });
                            
                            (s.items || []).slice(0,4).forEach((item, idx) => {
                                const xPos = 1.0 + (idx * 3.0);
                                // 菱形节点
                                slide.addShape('rect', { x: xPos + 1.2, y: 4.35, w: 0.3, h: 0.3, fill: { color: cyan }, rotate: 45 });
                                const parts = item.split(/[:：]/);
                                slide.addText(parts[0] || `Step ${idx+1}`, { x: xPos, y: 3.8, w: 2.7, align: 'center', fontSize: 14, bold: true, color: gold });
                                slide.addText(parts[1] || item, { x: xPos, y: 4.8, w: 2.7, align: 'center', fontSize: 11, color: textMain });
                            });
                        }
                        
                        // C. Comparison (对比)
                        else if (s.layout === 'comparison') {
                            // 左框 (默认/现状)
                            slide.addShape('rect', { x: 0.8, y: 1.8, w: 5.6, h: 5.0, line: { color: "444444" }, fill: { color: "111111", transparency:50 } });
                            slide.addText("PRESENT", { x: 1.0, y: 2.0, fontSize: 12, color: textDim, charSpacing:2 });
                            slide.addText(s.content, { x: 1.0, y: 2.5, w: 5.2, fontSize: 14, color: textMain });

                            // 右框 (未来/方案 - 金色高亮)
                            slide.addShape('rect', { x: 6.9, y: 1.8, w: 5.6, h: 5.0, line: { color: gold }, fill: { color: "111111", transparency:50 } });
                            // 右框角标
                            slide.addShape('rect', { x: 12.3, y: 1.8, w: 0.2, h: 0.2, fill: { color: gold } }); 
                            slide.addText("FUTURE", { x: 7.1, y: 2.0, fontSize: 12, color: gold, charSpacing:2 });
                            
                            (s.items || []).forEach((item, idx) => {
                                slide.addText(item, { 
                                    x: 7.1, y: 2.5 + (idx*0.6), w: 5.2, 
                                    fontSize: 14, color: textMain, bullet: { code: "25C6", color: cyan } 
                                });
                            });
                        }
                        
                        // D. Standard (经典)
                        else {
                            const textW = s.imgData ? 6.0 : 11.7;
                            // 正文
                            slide.addText(s.content, { x: 0.8, y: 1.2, w: textW, h: 1.5, fontSize: 16, color: textMain, align: "justify" });
                            // 列表
                            (s.items||[]).forEach((p, idx) => {
                                slide.addText(p, { x: 0.8, y: 3.0 + (idx*0.6), w: textW, fontSize: 14, color: textMain, bullet: { code: "25C6", color: gold } });
                            });

                            // 图片区
                            if (s.imgData) {
                                // 图片框装饰
                                slide.addShape('rect', { x: 7.3, y: 1.5, w: 5.0, h: 5.0, line: { color: gold, width: 1 } });
                                slide.addImage({ data: `image/png;base64,${s.imgData}`, x: 7.4, y: 1.6, w: 4.8, h: 4.8, sizing: { type: "cover", w: 4.8, h: 4.8 } });
                            }
                        }
                    });

                    pptx.writeFile({ fileName: `Fantasy-Deck-${Date.now()}.pptx` });
                };

                // Particle Logic (same as before)
                function initParticles() {
                    const canvas = document.getElementById('particle-canvas');
                    const ctx = canvas.getContext('2d');
                    let width, height;
                    const particles = [];
                    function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
                    window.addEventListener('resize', resize);
                    resize();
                    class Particle {
                        constructor() { this.reset(); }
                        reset() {
                            this.x = Math.random() * width; this.y = Math.random() * height;
                            this.vx = (Math.random() - 0.5) * 0.5; this.vy = (Math.random() - 0.5) * 0.5;
                            this.size = Math.random() * 2; this.alpha = Math.random() * 0.5;
                        }
                        update() {
                            this.x += this.vx; this.y += this.vy;
                            if (this.x < 0 || this.x > width || this.y < 0 || this.y > height) this.reset();
                        }
                        draw() {
                            ctx.fillStyle = `rgba(212, 183, 120, ${this.alpha})`;
                            ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
                        }
                    }
                    for(let i=0; i<80; i++) particles.push(new Particle());
                    function animate() { ctx.clearRect(0,0,width,height); particles.forEach(p => { p.update(); p.draw(); }); requestAnimationFrame(animate); }
                    animate();
                }

                return { 
                    step, nextStep, startGeneration, progressWidth, generationLog,
                    uiState, loading, error, topic, additionalInfo, slides, config, pptConfig, editForm, 
                    handleBgUpload, regenerateSlide, generateImage, openEditModal, closeEditModal, saveEdit, exportPPT 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
